<!DOCTYPE html>
<html lang="en">
  <head>
    <title>MyRide</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,500,600,700,800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/owl.carousel.min.css">
    <link rel="stylesheet" href="css/magnific-popup.css">
    <link rel="stylesheet" href="css/ionicons.min.css">
    <link rel="stylesheet" href="css/flaticon.css">
    <link rel="stylesheet" href="css/icomoon.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
          if (!(localStorage.hasOwnProperty("username"))) {
            window.location.href = "login.html";
          }
      });
    </script>
  </head>
  <body body onload="buildPage();">
    <script>
      document.addEventListener("DOMContentLoaded", function () {
          if (localStorage.getItem("isMaintainer") === 'true') {
            document.getElementById("li").innerHTML = `
	          <a href="maintainer.html" class="nav-link">Maintainer</a>
        	`
          }
      });
    </script>
	  <nav class="navbar navbar-expand-lg navbar-dark ftco_navbar bg-dark ftco-navbar-light" id="ftco-navbar">
	    <div class="container">
	      <a class="navbar-brand" href="index.html">My<span>Ride</span></a>
	      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#ftco-nav" aria-controls="ftco-nav" aria-expanded="false" aria-label="Toggle navigation">
	        <span class="oi oi-menu"></span> Menu
	      </button>
	      <div class="collapse navbar-collapse" id="ftco-nav">
	        <ul class="navbar-nav ml-auto">
	          <li class="nav-item active"><a href="index.html" class="nav-link">Home</a></li>
	          <li class="nav-item"><a href="stations.html" class="nav-link">Stations</a></li>
	          <li class="nav-item"><a href="chat.html" class="nav-link">Chat</a></li>
            <li class="nav-item"id="li"></li>
            <li id="logout_nav" class="nav-item"><a class="nav-link">Logout</a></li>
	        </ul>
	      </div>
	    </div>
	  </nav>
    <!-- END nav -->
    <div class="hero-wrap ftco-degree-bg" style="background-image: url('images/bg_1.jpg');" data-stellar-background-ratio="0.5">
      <div class="overlay"></div>
      <div class="container">
        <div class="row no-gutters slider-text justify-content-start align-items-center justify-content-center">
          <div class="col-lg-8 ftco-animate">
          	<div class="text w-100 text-center mb-md-5 pb-md-5">
	            <h1 class="mb-4">Welcome to MyRide</h1>
	            <p style="font-size: 18px;">MyRide is a platform that allows users to book a bike and use it for a certain period. At the end
                of this period, the user can leave the bike and declare its condition or extend the booking
                period. If the condition of the bike is drastic the user can contact through a chat a maintainer
                that will check the bike.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
     <section class="ftco-section ftco-no-pt bg-light">
    	<div class="container">
    		<div class="row no-gutters">
    			<div class="col-md-12	featured-top">
    				<div class="row no-gutters">
	  					<div class="col-md-4 d-flex align-items-center">
	  						<form id="search_station" action="stations.html" class="request-form ftco-animate bg-primary">
		          		<h2>Find A Bike</h2>
			    				<div class="form-group">
			    					<select id="type" name="type">
                      <option value="all">All</option>
                      <option value="city">City Bike</option>
                      <option value="mountain">Mountain Bike</option>
                      <option value="road">Road Bike</option>
                      <option value="tandem">Tandem Bike</option>
                    </select>
                    </div>
			            <div class="form-group">
			              <input type="submit" value="Search" class="btn btn-secondary py-3 px-4">
			            </div>
                </form>
                </div>
                <div id="release_bike_div"></div>
                <form class="request-form ftco-animate bg-primary" id="release_bike_form">
                </form>
	  					</div>
	  				</div>
        </div>
				</div>
  		</div>
    </section>
  <!-- loader -->
  <div id="ftco-loader" class="show fullscreen"><svg class="circular" width="48px" height="48px"><circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee"/><circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10" stroke="#F96D00"/></svg></div>
  
  <script src="js/jquery.min.js"></script>
  <script src="js/jquery-migrate-3.0.1.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery.easing.1.3.js"></script>
  <script src="js/jquery.waypoints.min.js"></script>
  <script src="js/jquery.stellar.min.js"></script>
  <script src="js/owl.carousel.min.js"></script>
  <script src="js/jquery.magnific-popup.min.js"></script>
  <script src="js/aos.js"></script>
  <script src="js/jquery.animateNumber.min.js"></script>
  <script src="js/bootstrap-datepicker.js"></script>
  <script src="js/jquery.timepicker.min.js"></script>
  <script src="js/scrollax.min.js"></script>
  <script src="js/main.js"></script>
  </body>
</html>
<script>
  async function buildPage(){
    await getActiveRide();
  }
  async function fillPage(activeRide){
    document.getElementById("release_bike_form").innerHTML=`<h2>Release Bike</h2>
              <div class="d-flex">
                <div class="form-group mr-2">
                  <div class="text">
                    <label class="label">BikeID: ${activeRide.bikeID} - Type: ${activeRide.bikeType} Bike</label>
                    <div class="d-flex mb-3">
                      <label class="label" id="timer_display"></label>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="station_id" class="label">Release Station</label>
                    <br>
                    <select id="station_id" name="station_id" required>
                    </select>
                  </div> 
                </div>
              </div>
              <div class="form-group">
                <input type="submit" value="Release" class="btn btn-secondary py-3 px-4">
              </div>`;
              updateTimer(activeRide.startTime);
              document.getElementById("release_bike_form").addEventListener("submit", function (event) {
                releaseBike(activeRide.rideID);
              });
              await getStations();
	}

  document.getElementById("logout_nav").addEventListener("click", function (event) {
      event.preventDefault();
      localStorage.removeItem("username");
      localStorage.removeItem("isMaintainer");
      window.location.href = "login.html";
  });

  async function getStations() {
    const STATIONS_ENDPOINT = "http://127.0.0.1:8080/stations/all";
    let res = '';
    await axios.get(STATIONS_ENDPOINT)
      .then(response => {
        res = response.data;
        if (res !== null & res != ""){
          fillOptions(res);
        }
      })
      .catch(error => {
        console.error("Error:", error);
      });
  }

  async function getActiveRide() {
    const ACTIVE_RIDE_ENDPOINT = "http://127.0.0.1:8080/ride/active/" + localStorage.getItem("username");
    await axios.get(ACTIVE_RIDE_ENDPOINT)
      .then(response => {
        const res = response.data;
        if (res != ''){ 
          fillPage(res);
        }  
      })
      .catch(error => {
        console.error("Error:", error);
      });
  }

  function fillOptions(stations){
  let options = document.getElementById("station_id");
  stations?.forEach(function (station) {
    let option = document.createElement("option");
    option.value = `${station.id}`;
    option.innerHTML = `${station.address}`;
    options.appendChild(option);
  });
}

function updateTimer(localDateTime) {
  var startTime = convertToLocalDateTime(localDateTime);
  var now = new Date();
  var elapsedTime = now - startTime;

  var milliseconds = elapsedTime % 1000;
  var seconds = Math.floor(elapsedTime / 1000) % 60;
  var minutes = Math.floor(elapsedTime / (1000 * 60)) % 60;
  var hours = Math.floor(elapsedTime / (1000 * 60 * 60)) % 24;
  var days = Math.floor(elapsedTime / (1000 * 60 * 60 * 24));
  var timerDisplay = document.getElementById("timer_display");
  timerDisplay.innerHTML = days + " days, " + hours + " hours, " + minutes + " minutes, " + seconds + " seconds";
  // Aggiorna ogni secondo
  setTimeout(function() {
      updateTimer(localDateTime);
  }, 1000);
}

function convertToLocalDateTime(localDateTime) {
  // Supponiamo che localDateTime sia nel formato 'yyyy-MM-ddTHH:mm:ss'
  var parts = localDateTime.split('T');
  var datePart = parts[0];
  var timePart = parts[1];
  
  var dateComponents = datePart.split('-');
  var timeComponents = timePart.split(':');
  
  // Costruzione dell'oggetto Date
  var year = parseInt(dateComponents[0]);
  var month = parseInt(dateComponents[1]) - 1; // Mese in JavaScript va da 0 a 11
  var day = parseInt(dateComponents[2]);
  var hour = parseInt(timeComponents[0]);
  var minute = parseInt(timeComponents[1]);
  var second = parseInt(timeComponents[2]);
  
  return new Date(year, month, day, hour, minute, second);
}

function releaseBike(rideID){
event.preventDefault();
const RELEASE_BIKE_ENDPOINT = "http://127.0.0.1:8080/ride/end";

const jsonData = {
  "rideID" : rideID,
  "stationID" : document.getElementById("station_id").value,
};
// Make Axios request
axios.post(RELEASE_BIKE_ENDPOINT, jsonData)
  .then(response => {
    console.log("Success:", response.data);
    location.reload();  
  })
  .catch(error => {
    console.error("Error:", error);
});
}
</script>
