<!DOCTYPE html>
<html lang="en">
  <head>
    <title>MyRide</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <link href="https://fonts.googleapis.com/css?family=Poppins:200,300,400,500,600,700,800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/owl.carousel.min.css">
    <link rel="stylesheet" href="css/magnific-popup.css">
    <link rel="stylesheet" href="css/ionicons.min.css">
    <link rel="stylesheet" href="css/flaticon.css">
    <link rel="stylesheet" href="css/icomoon.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="css/chat.css">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
      let username = null;
      let bikeID = null;
      document.addEventListener("DOMContentLoaded", function () {
          if (!(localStorage.hasOwnProperty("username"))) {
            window.location.href = "login.html";
          }
          else {
            const queryString = window.location.search;
	          const urlParams = new URLSearchParams(queryString);
			      urlParams.get("bike_id") == null ? window.location.href = "index.html"  : bikeID = urlParams.get("bike_id");
            username = localStorage.getItem("username");
          }
      });

      async function getRideByUsername(username) {
            const RIDE_ENDPOINT = "http://127.0.0.1:8080/ride/active/" + username;
            let res = '';
            await axios.get(RIDE_ENDPOINT)
              .then(response => {
                //console.log("Success:", response.data);
                res = response.data;
              })
              .catch(error => {
                //console.error("Error:", error);
              });
            return res;
      }

      async function check(){
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        var bikeID = Number(urlParams.get("bike_id"));
        var username = localStorage.getItem("username");
        const ride = await getRideByUsername(username);
        if(bikeID !== ride.bikeID) {
          window.location.href = "index.html";
        }
      }
      check();
    </script>

  </head>
  <body onload="connect(username,bikeID)" onunload="disconnect()">
    <script>
      document.addEventListener("DOMContentLoaded", function () {
          if (localStorage.getItem("isMaintainer") === 'true') {
            document.getElementById("maint").innerHTML = `
              <a href="maintainer.html" class="nav-link">Maintainer</a>
              `
            document.getElementById("cha").innerHTML = `
              <a href="chats.html" class="nav-link">Chats</a>
              `
          }
      });
    </script>

	  <nav class="navbar navbar-expand-lg navbar-dark ftco_navbar bg-dark ftco-navbar-light" id="ftco-navbar">
	    <div class="container">
	      <a class="navbar-brand" href="index.html">My<span>Ride</span></a>
	      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#ftco-nav" aria-controls="ftco-nav" aria-expanded="false" aria-label="Toggle navigation">
	        <span class="oi oi-menu"></span> Menu
	      </button>
	      <div class="collapse navbar-collapse" id="ftco-nav">
	        <ul class="navbar-nav ml-auto">
	          <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>
	          <li class="nav-item"><a href="stations.html" class="nav-link">Stations</a></li>
	          <li class="nav-item" id="cha"></li>
            <li class="nav-item"id="maint"></li>
            <li id="logout_nav" class="nav-item"><a class="nav-link">Logout</a></li>
	        </ul>
	      </div>
	    </div>
	  </nav>
    <!-- END nav -->
    <div class="hero-wrap ftco-degree-bg" style="background-image: url('images/bg_5.jpg');" data-stellar-background-ratio="0.5">
      <div class="overlay"></div>
      <div class="container">
        <div class="row slider-text align-items-center justify-content-start">
          <div class="col-lg-8 ftco-animate">
          	<div class="col-md-9 ftco-animate pb-5">
	            <h1 class="mb-3 bread">Chat With Us</h1>
	            <p style="font-size: 18px;">Wait for a maintainer to contact you. Messages sent before won't be seen.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <section class="ftco-section ftco-no-pt bg-light">
    	<div class="container">
    		<div class="row no-gutters">
    			<div class="col-md-12	featured-top">
                  <div id="chat-container">
                    <div class="chat">
                        <main id="chatservice-chat"> </main>
                        <div class="chat-submit-area">
                            <input type="text" id="chat-submit-area-input" placeholder="Enter your message...">
                            <button type="submit" class="btn btn-primary py-3 px-5" onclick="sendMessage()">
                                Send
                            </button>
                        </div>
                    </div>
                  </div>
          </div>
        </div>
      </div>
    </section>

    
  <!-- loader -->
  <div id="ftco-loader" class="show fullscreen"><svg class="circular" width="48px" height="48px"><circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee"/><circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10" stroke="#F96D00"/></svg></div>


  <script src="js/jquery.min.js"></script>
  <script src="js/jquery-migrate-3.0.1.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery.easing.1.3.js"></script>
  <script src="js/jquery.waypoints.min.js"></script>
  <script src="js/jquery.stellar.min.js"></script>
  <script src="js/owl.carousel.min.js"></script>
  <script src="js/jquery.magnific-popup.min.js"></script>
  <script src="js/aos.js"></script>
  <script src="js/jquery.animateNumber.min.js"></script>
  <script src="js/bootstrap-datepicker.js"></script>
  <script src="js/jquery.timepicker.min.js"></script>
  <script src="js/scrollax.min.js"></script>
  <script src="js/main.js"></script>

  <script>
    document.getElementById("logout_nav").addEventListener("click", function (event) {
        event.preventDefault();
        localStorage.removeItem("username");
        localStorage.removeItem("isMaintainer");
        window.location.href = "login.html";
    });

    
    let websocket;
    const START = "START";
    const MESSAGE = "MESSAGE";
    let id_timer = null;
    const serverUrl = "ws://127.0.0.1:8300/";

    const websocketConfigurationParameters = {
      0: "opcode",
      1: "username",
      2: "bike_id"
    };

    const messageParameters = {
      0: "opcode",
      1: "text"   
    };

    function connect(loggedUser, bikeID){
      // Setup websocket connection
      websocket = new WebSocket(serverUrl);
      websocket.onopen = openWebsocketConnection;
      websocket.onclose = closeWebsocketConnection;
      websocket.onmessage = receiveObjectThroughWebsocket;
      websocket.onerror = handleWebsocketError;
    }

    /**
    * function that execute the disconnect with the websocket
    */
    function disconnect(){
      //the websocket is closed and the onclose method is invoked
      websocket.close();
    }
    
    /**
    * this function create an object from the args passed and
    * send it through the websocket
    * @param isWebsocketConfigurationMessage is a boolean value that select the right parameters
    *                                        for the object creation
    * @param args  are all the parameters of the object
    */
    function sendObjectThroughWebsocket(isWebsocketConfigurationMessage, ...args){
      // create a JSON object
      const json_string = {};
      // generate the params for the type of object websocket vs chat params
      for( let i = 0; i < args.length; i++ ){
        const parameter = isWebsocketConfigurationMessage ? websocketConfigurationParameters[i]: messageParameters[i];
        json_string[parameter] = args[i];
      }
      // send JSON object
      websocket.send(JSON.stringify(json_string));
    }

    /**
     * this function start the connection with websocket, sending the start message
     * and with the start of the automatic refresh of the websocket connection, by the call of the
     * provided function
     */
    function openWebsocketConnection(){
        // creation json object
        sendObjectThroughWebsocket(true, START, username, bikeID);
    }

    /**
     * this function is invoked when the connection with the websocket is closed
     */
    function closeWebsocketConnection(){
        console.error("WebSocket connection closed");
        // Try to connect again to chat servers
        setTimeout(function() {
            connect(username, bikeID);
        }, 1000);
    }

    /**
     * function that parse the JSON object received and execute the action
     * provided by the opcode parameter of the object
     * @param event is the JSON object that has to be parsed
     */
    function receiveObjectThroughWebsocket(event){
        // parse of the JSON object received and execute
        const message = JSON.parse(event.data);
        if(message.opcode === MESSAGE){
            appendMessageToTheChat(message.sender, message.text, false);
        }
        else{
            alert("Unknown Message Received");
        }
    }

    /**
     * function that handle possible errors with the websocket connection
     */
    function handleWebsocketError() {
        if (websocket.readyState === 3) {
            // Connection is closed
            //alert("Error: cannot connect to chat server");
        }
        console.log("Websocket error");
    }

    /**
     * function that create a JSON object message with the provided function and
     * that append it directly to the chat of the user, because it is one of his messages
     */
    function sendMessage(){

        const input_message = document.getElementById("chat-submit-area-input");
        const message_text = input_message.value;
        input_message.value = "";
        
        if (websocket.readyState === 3) {
            // Connection closed
            //alert("Error: the chat is offline. Please wait for reconnection");
        }
        else {
            sendObjectThroughWebsocket(false, MESSAGE, message_text);
            appendMessageToTheChat("You", message_text, true);
        }
    }

    /**
     * function that append a message to the div of the chat
     * @param sender_name is the name of the sender, if the sender is the user it is
     *                      substituted by the YOU word
     * @param message is the text of the message
     * @param isMyMessage is a boolean, in order to understand if the sender is the user
     *                    or another student
     */
    function appendMessageToTheChat(sender_name, message, isMyMessage){

        const chatContainer = document.getElementById("chatservice-chat");

        const divMessageContainer = document.createElement("div");

        const divStudentProfile = document.createElement("div");
        divStudentProfile.setAttribute("class", "student-profile-image");

        const divMessage = document.createElement("div");
        divMessage.setAttribute("class", "message");

        const divMessageHeader = document.createElement("div");
        divMessageHeader.setAttribute("class", "message-header");

        const divMessageHeaderUsername = document.createElement("div");
        divMessageHeaderUsername.setAttribute("class", "message-header-username");
        divMessageHeaderUsername.textContent = sender_name;

        const divMessageContent = document.createElement("div");
        divMessageContent.setAttribute("class", "message-content");
        divMessageContent.textContent = message;

        if(isMyMessage){
            divMessageContainer.setAttribute("class", "message-container sent-message");
        }
        else{
            divMessageContainer.setAttribute("class", "message-container received-message");
        }

        chatContainer.appendChild(divMessageContainer);
        divMessageContainer.appendChild(divStudentProfile);
        divMessageContainer.appendChild(divMessage);
        divMessage.appendChild(divMessageHeader);
        divMessageHeader.appendChild(divMessageHeaderUsername);
        divMessage.appendChild(divMessageContent);
        
        // Scroll chat to bottom
        scrollChatToBottom();
    }

    /**
     * Scroll chat to bottom
     */
    function scrollChatToBottom() {
        const chat = document.getElementById("chatservice-chat");
        chat.scrollTop = chat.scrollHeight;
    }
  </script>
  </body>
</html>